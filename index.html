<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCR Pro - Smart AI Edition</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <script src='https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- Style Dasar & Dark Mode --- */
        :root { --bg-color: #f5f7fa; --box-bg: #ffffff; --text-color: #363636; --border-color: #dbdbdb; --upload-bg: #fdfdfd; }
        body.dark-mode { --bg-color: #1a1b1e; --box-bg: #2c2e33; --text-color: #e0e0e0; --border-color: #4a4a4a; --upload-bg: #25262b; }
        body { background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s; min-height: 100vh; }
        .box { background-color: var(--box-bg); color: var(--text-color); transition: background-color 0.3s; }
        .title, .subtitle, .label, strong { color: var(--text-color) !important; }
        
        /* Upload Zone */
        .upload-zone {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed #3298dc; border-radius: 12px; padding: 2.5rem;
            cursor: pointer; background-color: var(--upload-bg); transition: all 0.3s; width: 100%; box-sizing: border-box;
            position: relative;
        }
        .upload-zone:hover { background-color: rgba(50, 152, 220, 0.05); border-color: #205e8e; }
        .upload-zone.is-dragover { background-color: rgba(72, 199, 116, 0.1) !important; border-color: #48c774 !important; transform: scale(1.02); }
        body.dark-mode .upload-zone:hover { background-color: rgba(50, 152, 220, 0.1); }

        /* Switch Toggle Style */
        .switch-wrapper { position: relative; display: inline-block; width: 40px; height: 22px; vertical-align: middle; }
        .switch-wrapper input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #48c774; }
        input:checked + .slider:before { transform: translateX(18px); }
        .slider.orange-slider { background-color: #ccc; }
        input:checked + .slider.orange-slider { background-color: #ff9f43; }

        /* Icon next to switch */
        .control-icon { font-size: 1rem; color: #b5b5b5; margin-right: 6px; vertical-align: middle; }
        body.dark-mode .control-icon { color: #666; }
        .control-item { display: flex; align-items: center; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 20px; border: 1px solid transparent; }
        body.dark-mode .control-item { background: rgba(255,255,255,0.05); }

        /* Result Text Area */
        #result-text { min-height: 200px; max-height: 600px; font-family: 'Consolas', monospace; font-size: 0.9em; background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color); }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #image-preview { max-height: 300px; object-fit: contain; border-radius: 6px; border: 1px solid var(--border-color); display: none; margin: 0 auto; }
        
        /* Stats & History */
        .stats-tag { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .history-item { border-left: 4px solid #3298dc; cursor: pointer; transition: all 0.2s; }
        .history-item:hover { transform: translateX(5px); }
        .history-date { font-size: 0.75rem; color: #888; }
        body.dark-mode .history-item { background-color: #3a3b3c; color: #e0e0e0; border-color: #48c774; }

        /* Cropper */
        .cropper-container-box { height: 400px; background-color: #333; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        #cropper-image { max-width: 100%; display: block; }
        
        .auto-fix-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
            display: inline-flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- STYLE KHUSUS DONASI --- */
        .support-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 1rem; }
        .btn-donate { transition: all 0.3s; border: none !important; color: white !important; font-weight: 600; }
        .btn-saweria { background-color: #f1c40f !important; color: #4a4a4a !important; }
        .btn-saweria:hover { background-color: #d4ac0d !important; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.4); transform: translateY(-2px); }
        .btn-trakteer { background-color: #e74c3c !important; }
        .btn-trakteer:hover { background-color: #c0392b !important; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4); transform: translateY(-2px); }

        /* --- STYLE TOMBOL EXPORT --- */
        .export-group .button { margin-bottom: 5px; }

        /* --- MOBILE SPECIFIC FIXES (UPDATED) --- */
        @media screen and (max-width: 768px) {
            .section { padding: 1.25rem 0.75rem; }
            .box { padding: 1rem; }
            
            /* Fix Header Spacing: Biar Reset gak nyatu sama Logo */
            .level.is-mobile { gap: 10px; } 
            
            .title.is-4 { font-size: 1rem; margin-bottom: 0 !important; white-space: nowrap; }
            .tag.is-success { display: none; }
            .control-item { padding: 2px 6px; margin-left: 4px !important; }
            .control-icon { font-size: 0.9rem; margin-right: 4px; }
            .switch-wrapper { width: 34px; height: 18px; }
            .slider:before { height: 14px; width: 14px; left: 2px; bottom: 2px; }
            input:checked + .slider:before { transform: translateX(16px); }
            
            .upload-zone { padding: 1.5rem; }
            .upload-zone p.is-size-5 { font-size: 0.95rem !important; }
            .level-right { margin-top: 0; } /* Reset margin di mobile level */
            
            .export-group { display: flex; flex-direction: column; width: 100%; }
            .export-group .button { width: 100%; margin-right: 0 !important; margin-bottom: 8px; }
            #text-stats { display: flex; flex-wrap: wrap; justify-content: center; }
            .cropper-container-box { height: 300px; }
        }
    </style>
</head>
<body>

    <section class="section">
        <div class="container is-max-desktop">
            <div class="box shadow-lg fade-in">
                
                <div class="level is-mobile mb-4 pb-3" style="border-bottom: 1px solid var(--border-color); align-items: center;">
                    <div class="level-left">
                        <div style="max-width: 50vw;">
                            <p class="title is-4 is-flex is-align-items-center">
                                <span class="icon mr-2 has-text-info"><i class="fas fa-robot"></i></span>
                                <span>OCR Pro</span>
                            </p>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="is-flex is-align-items-center">
                            
                            <div class="control-item mr-2" title="Mode Editor (Crop)">
                                <i class="fas fa-crop-alt control-icon"></i>
                                <label class="switch-wrapper">
                                    <input type="checkbox" id="editor-mode-toggle" checked>
                                    <span class="slider orange-slider"></span>
                                </label>
                            </div>

                            <div class="control-item">
                                <i class="fas fa-moon control-icon"></i>
                                <label class="switch-wrapper">
                                    <input type="checkbox" id="dark-mode-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <button id="reset-button" class="button is-small is-rounded is-light ml-3" title="Reset">
                                <span class="icon is-small"><i class="fas fa-sync-alt"></i></span>
                            </button>

                        </div>
                    </div>
                </div>

                <p class="subtitle is-6 has-text-grey mb-4 is-size-7-mobile">
                    Unggah gambar/PDF. Gunakan <span class="tag is-info is-light">Ctrl + V</span> untuk paste.
                </p>

                <div class="field">
                    <div class="upload-zone" id="drop-zone">
                        <span class="icon is-large has-text-link mb-2"><i class="fas fa-cloud-upload-alt fa-3x"></i></span>
                        <p class="is-size-5 has-text-weight-medium mt-2">Klik / Tarik File Kesini</p>
                        <p id="file-name" class="is-size-7 has-text-grey mt-1">Belum ada file dipilih</p>
                        <input type="file" id="uploader" accept="image/*,application/pdf" style="display:none;" />
                    </div>
                </div>

                <div id="preview-section" class="block has-text-centered mt-4" style="display: none;">
                    <div class="auto-fix-badge mb-2"><i class="fas fa-magic mr-2"></i> Auto-Enhanced Active</div>
                    <br>
                    <img id="image-preview" src="#" alt="Preview" />
                </div>

                <div id="status-box" class="notification is-info is-light mt-5 is-size-7-mobile">
                    <div class="icon-text">
                        <span class="icon"><i class="fas fa-info-circle"></i></span>
                        <span id="status-text">Siap memproses dokumen...</span>
                    </div>
                </div>

                <div id="result-section" class="mt-5 fade-in" style="display: none;">
                    <div class="level is-mobile mb-2">
                        <div class="level-left"><h3 class="title is-5 is-size-6-mobile mb-0">Hasil Teks</h3></div>
                        <div class="level-right">
                            <button id="copy-button" class="button is-small is-link is-outlined is-rounded">
                                <span class="icon"><i class="far fa-copy"></i></span>
                                <span id="copy-text">Salin</span>
                            </button>
                        </div>
                    </div>

                    <div class="control">
                        <textarea id="result-text" class="textarea" readonly placeholder="Hasil akan muncul di sini..."></textarea>
                    </div>

                    <div id="post-result-actions" class="level mt-4 is-flex-wrap-wrap">
                        <div class="level-left mb-2">
                            <div id="text-stats" class="tags"></div>
                        </div>
                        <div class="level-right export-group">
                            <button onclick="exportToTxt()" class="button is-small is-primary is-rounded mr-1 shadow-sm">
                                <span class="icon"><i class="fas fa-file-alt"></i></span> <span>TXT</span>
                            </button>
                            <button onclick="exportToWord()" class="button is-small is-info is-light is-rounded mr-1 shadow-sm">
                                <span class="icon"><i class="fas fa-file-word"></i></span> <span>Word</span>
                            </button>
                            <button onclick="exportToPDF()" class="button is-small is-danger is-light is-rounded mr-1 shadow-sm">
                                <span class="icon"><i class="fas fa-file-pdf"></i></span> <span>PDF</span>
                            </button>
                            <button onclick="exportToExcel()" class="button is-small is-success is-light is-rounded shadow-sm">
                                <span class="icon"><i class="fas fa-file-excel"></i></span> <span>Excel</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="history-section" class="mt-6 pt-5" style="border-top: 1px dashed var(--border-color); display:none;">
                    <div class="level is-mobile mb-4">
                        <div class="level-left">
                            <h4 class="title is-6 has-text-grey">üïê Riwayat</h4>
                        </div>
                        <div class="level-right">
                            <button id="clear-history" class="button is-small is-danger is-light is-rounded">Hapus</button>
                        </div>
                    </div>
                    <div id="history-list"></div>
                </div>

                <div id="support-section" class="mt-6 p-5 has-text-centered" style="border-top: 1px solid var(--border-color); background-color: rgba(0,0,0,0.015); border-radius: 8px;">
                    <h4 class="title is-6 mb-3"><i class="fas fa-heart has-text-danger"></i> Dukung Karya Saya</h4>
                    <p class="is-size-6 mb-4 has-text-grey-dark" style="font-style: italic;">
                        "Server gratisan tapi kopi bayar sendiri. Bantu developer tetap melek? Klik di bawah!" üòé
                    </p>
                    <div class="support-buttons">
                        <a href="https://saweria.co/USERNAME_KAMU" target="_blank" class="button btn-saweria btn-donate">
                            <span class="icon"><i class="fas fa-coffee"></i></span>
                            <span>Saweria</span>
                        </a>
                        <a href="https://trakteer.id/USERNAME_KAMU" target="_blank" class="button btn-trakteer btn-donate">
                            <span class="icon"><i class="fas fa-gift"></i></span>
                            <span>Trakteer</span>
                        </a>
                    </div>
                </div>

            </div>
            <p class="has-text-centered is-size-7 has-text-grey-light mt-4">Powered by Tesseract.js & Smart Regex</p>
        </div>
    </section>

    <div id="crop-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title is-size-5">Edit Area Scan</p>
                <button class="delete" aria-label="close" id="close-modal"></button>
            </header>
            <section class="modal-card-body">
                <div class="cropper-container-box">
                    <img id="cropper-image" src="" alt="Edit Image">
                </div>
                <div class="buttons is-centered mt-4">
                    <button class="button is-small is-rounded" onclick="rotateImage(-90)" title="Putar Kiri"><span class="icon"><i class="fas fa-undo"></i></span></button>
                    <button class="button is-small is-rounded" onclick="rotateImage(90)" title="Putar Kanan"><span class="icon"><i class="fas fa-redo"></i></span></button>
                    
                    <button class="button is-small is-rounded is-danger is-light" onclick="resetCropper()" title="Reset">
                        <span class="icon mr-1"><i class="fas fa-sync"></i></span> Reset
                    </button>

                </div>
                <p class="has-text-centered is-size-7 has-text-grey mt-2"><i class="fas fa-magic has-text-info"></i> Auto-Enhance Aktif</p>
            </section>
            <footer class="modal-card-foot is-justify-content-flex-end">
                <button class="button" id="cancel-crop">Batal</button>
                <button class="button is-success" id="process-crop">
                    <span class="icon mr-1"><i class="fas fa-check"></i></span> Proses
                </button>
            </footer>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Elements
        const uploader = document.getElementById('uploader');
        const dropZone = document.getElementById('drop-zone');
        const fileNameDisplay = document.getElementById('file-name');
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        const statusIcon = statusBox.querySelector('.icon i');
        const imagePreview = document.getElementById('image-preview');
        const previewSection = document.getElementById('preview-section');
        const resultSection = document.getElementById('result-section');
        const resultText = document.getElementById('result-text');
        const copyButton = document.getElementById('copy-button');
        const resetButton = document.getElementById('reset-button');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const editorModeToggle = document.getElementById('editor-mode-toggle');
        const textStats = document.getElementById('text-stats');
        
        // History & Modal
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history');
        const cropModal = document.getElementById('crop-modal');
        const cropperImage = document.getElementById('cropper-image');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelCropBtn = document.getElementById('cancel-crop');
        const processCropBtn = document.getElementById('process-crop');

        let currentFileName = 'hasil_ocr.txt';
        let cropperInstance = null;
        loadHistory();

        // --- HANDLER FILE ---
        dropZone.addEventListener('click', () => uploader.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false);
            document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('is-dragover'), false));
        ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('is-dragover'), false));
        dropZone.addEventListener('drop', (e) => { if(e.dataTransfer.files.length > 0) handleFileSelection(e.dataTransfer.files[0]); });
        uploader.addEventListener('change', (e) => { if(e.target.files.length > 0) handleFileSelection(e.target.files[0]); });
        window.addEventListener('paste', async (e) => {
            const file = e.clipboardData.files[0];
            if (file && file.type.startsWith('image/')) { e.preventDefault(); handleFileSelection(file, 'Clipboard Image.png'); }
        });

        // --- LOGIKA PEMILIHAN FILE ---
        function handleFileSelection(file, nameOverride = null) {
            currentFileName = nameOverride || file.name;
            fileNameDisplay.textContent = currentFileName;
            
            if (file.type.startsWith('image/')) {
                if (editorModeToggle.checked) {
                    openCropperModal(file);
                } else {
                    resetUI();
                    previewSection.style.display = 'block';
                    imagePreview.src = URL.createObjectURL(file);
                    imagePreview.style.display = 'block';
                    processImage(file).then(finishProcessing).catch(handleError);
                }
            } else if (file.type === 'application/pdf') {
                resetUI(); processPDF(file).then(finishProcessing).catch(handleError);
            } else {
                alert('Format file tidak didukung');
            }
        }

        // --- FUNGSI MODAL CROPPER ---
        function openCropperModal(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                cropperImage.src = e.target.result;
                cropModal.classList.add('is-active');
                if (cropperInstance) cropperInstance.destroy();
                cropperInstance = new Cropper(cropperImage, { viewMode: 1, autoCropArea: 1, responsive: true });
            };
            reader.readAsDataURL(file);
        }

        function closeCropperModal() {
            cropModal.classList.remove('is-active');
            if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
            uploader.value = '';
        }

        closeModalBtn.onclick = closeCropperModal;
        cancelCropBtn.onclick = closeCropperModal;
        window.rotateImage = (d) => cropperInstance && cropperInstance.rotate(d);
        window.resetCropper = () => cropperInstance && cropperInstance.reset();

        processCropBtn.onclick = () => {
            if (!cropperInstance) return;
            const croppedCanvas = cropperInstance.getCroppedCanvas();
            croppedCanvas.toBlob((blob) => {
                closeCropperModal(); resetUI();
                previewSection.style.display = 'block';
                imagePreview.src = URL.createObjectURL(blob); imagePreview.style.display = 'block';
                processImage(blob).then(finishProcessing).catch(handleError);
            }, 'image/png');
        };

        // --- FUNGSI UTAMA OCR & PDF ---
        const cleanOCRText = (text) => {
            let cleaned = text;
            cleaned = cleaned.replace(/\b([CDE]):\s*[l|I|i|\|/]\s*/g, "$1:\\"); 
            cleaned = cleaned.replace(/Snort\s*[l|I|i|\|/]\s*etc/gi, "Snort\\etc"); 
            cleaned = cleaned.replace(/Snort\s*[l|I|i|\|/]\s*bin/gi, "Snort\\bin"); 
            cleaned = cleaned.replace(/C\s*[l|I|i|\|/]\s*Snort/gi, "C:\\Snort"); 
            cleaned = cleaned.replace(/fi\\e/g, "file"); cleaned = cleaned.replace(/ru\\es/g, "rules"); 
            cleaned = cleaned.replace(/ru\|es/g, "rules"); cleaned = cleaned.replace(/modu\\/g, "modul"); 
            cleaned = cleaned.replace(/KONFIGURAS\\/g, "KONFIGURASI"); 
            cleaned = cleaned.replace(/([a-z])1([a-z])/g, "$1l$2"); cleaned = cleaned.replace(/([a-z])0([a-z])/g, "$1o$2"); 
            cleaned = cleaned.replace(/SNCRT/gi, "SNORT"); cleaned = cleaned.replace(/snert/gi, "snort");
            cleaned = cleaned.replace(/1D5/g, "IDS"); cleaned = cleaned.replace(/1DS/g, "IDS");
            cleaned = cleaned.replace(/30\s*rules/gi, "so_rules"); cleaned = cleaned.replace(/so\s+ru\\es/gi, "so_rules"); 
            cleaned = cleaned.replace(/so\s+rules/gi, "so_rules"); cleaned = cleaned.replace(/preproc\s*rules/gi, "preproc_rules");
            return cleaned;
        };

        const updateStatus = (message, type = 'info') => {
            statusText.textContent = message;
            statusBox.className = 'notification mt-5 is-size-7-mobile'; statusIcon.className = '';
            const types = { info: ['is-info','is-light','fa-info-circle'], success: ['is-success','is-light','fa-check-circle'], error: ['is-danger','is-light','fa-exclamation-triangle'], loading: ['is-warning','is-light','fa-spinner','fa-spin'] };
            const t = types[type] || types.info;
            statusBox.classList.add(t[0], t[1]); statusIcon.classList.add('fas', t[2], ...(type === 'loading' ? ['fa-spin'] : []));
        };

        const resetUI = () => {
            resultSection.style.display = 'none'; previewSection.style.display = 'none';
            resultText.value = ''; 
            updateStatus('Siap memproses dokumen...', 'info');
        };

        // --- UPDATE STATS UI ---
        function updateStatsUI(text, conf) {
            let confColor = conf > 85 ? 'is-success' : (conf > 60 ? 'is-warning' : 'is-danger');
            textStats.innerHTML = `<span class="tag is-light stats-tag"><i class="fas fa-font mr-1"></i> ${text.length} Karakter</span> <span class="tag ${confColor} is-light stats-tag"><i class="fas fa-bullseye mr-1"></i> ${conf}%</span>`;
        }

        function finishProcessing(result) {
            const txt = result.text || "Tidak ada teks.";
            const conf = Math.round(result.confidence || 0);
            resultText.value = txt; 
            resultSection.style.display = 'block';
            updateStatus('Selesai!', 'success');
            saveToHistory(currentFileName, txt, conf);
            updateStatsUI(txt, conf);
        }
        
        function handleError(e) { updateStatus(`Error: ${e.message}`, 'error'); console.error(e); }

        // --- SMART PROCESS IMAGE ---
        const processImage = async (blobFile) => {
            updateStatus('Optimasi Gambar (Smart Contrast)...', 'loading');
            
            let imgSource = blobFile;
            if (blobFile instanceof File || blobFile instanceof Blob) { imgSource = URL.createObjectURL(blobFile); }
            
            const img = new Image(); 
            img.src = imgSource; 
            await new Promise(r => img.onload = r);
            
            const canvas = document.createElement('canvas'); 
            const ctx = canvas.getContext('2d');
            
            const scale = 3; 
            canvas.width = img.width * scale; 
            canvas.height = img.height * scale;
            
            ctx.imageSmoothingEnabled = false; 
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = imageData.data;
            
            let totalBrightness = 0;
            for(let i=0; i<data.length; i+=4){
                totalBrightness += (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
            }
            const avgBrightness = totalBrightness / (data.length / 4);
            const isDarkMode = avgBrightness < 128; 

            for(let i=0; i<data.length; i+=4){ 
                let gray = (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
                if(isDarkMode) gray = 255 - gray;
                gray = (gray - 128) * 1.5 + 128; 
                if(gray < 0) gray = 0; if(gray > 255) gray = 255;
                data[i] = gray; data[i+1] = gray; data[i+2] = gray; 
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const worker = await Tesseract.createWorker('ind+eng', 1, { 
                logger: m => m.status === 'recognizing text' && updateStatus(`Membaca: ${(m.progress * 100).toFixed(0)}%`, 'loading') 
            });
            await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.AUTO });
            const { data: res } = await worker.recognize(canvas); 
            await worker.terminate();
            
            return { text: cleanOCRText(res.text), confidence: res.confidence };
        };

        const processPDF = async (file) => {
            updateStatus('Membaca PDF...', 'loading');
            const typedarray = new Uint8Array(await file.arrayBuffer());
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '', totalConf = 0;
            const worker = await Tesseract.createWorker('ind+eng');
            for(let i=1; i<=pdf.numPages; i++){
                updateStatus(`Hal ${i}/${pdf.numPages}...`, 'loading');
                const page = await pdf.getPage(i); const vp = page.getViewport({scale:2.5});
                const cvs = document.createElement('canvas'); cvs.width=vp.width; cvs.height=vp.height;
                await page.render({canvasContext:cvs.getContext('2d'), viewport:vp}).promise;
                const { data } = await worker.recognize(cvs);
                fullText += `--- Halaman ${i} ---\n${cleanOCRText(data.text)}\n\n`; totalConf += data.confidence;
                resultText.value = fullText; resultSection.style.display = 'block';
            }
            await worker.terminate();
            return { text: fullText, confidence: totalConf/pdf.numPages };
        };

        function saveToHistory(fname, text, conf) {
            let history = JSON.parse(localStorage.getItem('ocrHistory') || '[]');
            const newItem = { id: Date.now(), name: fname, text: text, conf: conf, date: new Date().toLocaleString('id-ID') };
            history.unshift(newItem); if(history.length > 5) history.pop();
            localStorage.setItem('ocrHistory', JSON.stringify(history)); loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('ocrHistory') || '[]');
            historyList.innerHTML = '';
            if(history.length > 0) {
                historySection.style.display = 'block';
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'notification is-light mb-2 p-3 history-item';
                    div.innerHTML = `<div class="is-flex is-justify-content-space-between"><strong>${item.name}</strong><span class="tag is-small ${item.conf > 80 ? 'is-success' : 'is-warning'} is-light">${item.conf}%</span></div><p class="is-size-7 has-text-grey-light is-family-monospace mt-1" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.text.substring(0, 60)}...</p><div class="history-date mt-1">${item.date}</div>`;
                    
                    div.onclick = () => { 
                        resultText.value = item.text; 
                        resultSection.style.display = 'block'; 
                        window.scrollTo({ top: resultSection.offsetTop, behavior: 'smooth' }); 
                        updateStatus(`Memuat riwayat: ${item.name}`, 'info');
                        updateStatsUI(item.text, item.conf);
                    };
                    
                    historyList.appendChild(div);
                });
            } else historySection.style.display = 'none';
        }

        // --- FUNGSI EXPORT ---
        function exportToTxt() {
            const blob = new Blob([resultText.value], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'hasil_ocr.txt';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const text = resultText.value;
            const splitText = doc.splitTextToSize(text, 180); 
            doc.setFontSize(10); doc.text(splitText, 10, 10);
            doc.save('ocr_result.pdf');
        }

        function exportToWord() {
            const text = resultText.value.replace(/\n/g, "<br>");
            const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title><style>body{font-family:'Calibri','Arial',sans-serif;font-size:11pt;line-height:1.5;color:#000000;}p{margin:0;padding:0;}</style></head><body>`;
            const footer = "</body></html>";
            const sourceHTML = header + text + footer;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload); fileDownload.href = source; fileDownload.download = 'hasil_ocr.doc';
            fileDownload.click(); document.body.removeChild(fileDownload);
        }

        function exportToExcel() {
            const text = resultText.value;
            const rows = text.split('\n').map(line => [line]);
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "OCR Data");
            XLSX.writeFile(wb, "ocr_result.xlsx");
        }

        clearHistoryBtn.addEventListener('click', () => { if(confirm('Hapus semua riwayat scan?')) { localStorage.removeItem('ocrHistory'); loadHistory(); }});
        copyButton.addEventListener('click', () => { resultText.select(); navigator.clipboard.writeText(resultText.value).then(() => { const icon = copyButton.querySelector('i'); const txt = document.getElementById('copy-text'); copyButton.className='button is-small is-success is-rounded'; icon.className='fas fa-check'; txt.textContent='Tersalin'; setTimeout(() => { copyButton.className='button is-small is-link is-outlined is-rounded'; icon.className='far fa-copy'; txt.textContent='Salin'; }, 2000); }); });
        resetButton.addEventListener('click', () => { uploader.value = ''; fileNameDisplay.textContent = 'Belum ada file dipilih'; resetUI(); });
        
        const toggleDarkMode = (isDark) => { if (isDark) { document.body.classList.add('dark-mode'); darkModeToggle.checked = true; } else { document.body.classList.remove('dark-mode'); darkModeToggle.checked = false; } };
        darkModeToggle.addEventListener('change', () => { const isDark = darkModeToggle.checked; toggleDarkMode(isDark); localStorage.setItem('darkMode', isDark); });
        const saveEditorState = () => localStorage.setItem('editorMode', editorModeToggle.checked);
        editorModeToggle.addEventListener('change', saveEditorState);
        const savedMode = localStorage.getItem('darkMode') === 'true'; toggleDarkMode(savedMode);
        const savedEditor = localStorage.getItem('editorMode');
        if(savedEditor !== null) editorModeToggle.checked = (savedEditor === 'true');
    </script>
</body>
</html>
